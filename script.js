// ============================================
// 知遇籤 (jasyooc.com) 主程式
// Version: 3.0.0
// ============================================

// --- 預設籤文庫 (完整的 60 支籤文數據) ---
const fortuneSticks = [
    {
        number: "第一籤", title: "上吉 龍虎相會", verse: "龍虎風雲際會時，雷霆震動起新機。萬事亨通皆得意，占得斯籤百不疑。",
        interpretation: "此籤為上吉之選，喻示有利的時機即將降臨。**事業：** 猶如龍虎相會，有機會大展宏圖，職位或項目展望樂觀。**財運：** 財源趨向穩健，投資宜把握新機。**婚姻：** 緣分已到，是締結良緣的良好時機。**健康：** 身體狀況有望好轉，保持活力。**學業：** 學習效率提高，成績有所進步。**尋人：** 有望獲知其消息。**失物：** 有機會尋回。",
        keywords: ['事業', '開始', '升職', '投資', '婚姻', '機遇', '順利', '前景', '貴人', '新機', '上吉', '成功']
    },
    {
        number: "第二籤", title: "中吉 欲求仙方", verse: "雲深霧罩山重重，欲求仙方問天翁。功名財利難如意，且須等到花開時。",
        interpretation: "此籤顯示目前處於觀察等待階段，切勿急躁。**事業：** 努力付出，但短期內回報不明顯，宜穩守本位。**財運：** 收入穩定，但不宜進行高風險投資。**婚姻：** 感情發展緩慢，需要更多時間培養。**健康：** 須留意身體小恙，及時調理。**學業：** 基礎需夯實，不可投機取巧。**尋人：** 暫無消息，需耐心等待。**失物：** 尋回機會不大，或需費一番周折。",
        keywords: ['等待', '緩慢', '耐心', '觀察', '穩守', '平靜', '困難', '中吉', '時間', '積蓄', '調理']
    },
    {
        number: "第三籤", title: "中平 漁翁撒網", verse: "不見魚兒滿網歸，皆因潮退水流低。一朝潮漲添舟楫，魚躍龍門自可期。",
        interpretation: "此籤喻示目前機緣未至，需等待時機。**事業：** 暫時未見成績，宜靜待市場或環境變化。**財運：** 收入平穩，不宜大額投資，等待資金回流。**婚姻：** 感情尚處於鋪墊階段，不宜強求結果。**健康：** 注意季節變化，多休息。**學業：** 努力已經足夠，欠缺的只是發揮的機會。**尋人：** 很快會有消息。**失物：** 可尋，在水中或北方。",
        keywords: ['等待', '時機', '中平', '潮漲', '努力', '積累', '耐心', '變化', '事業', '財運']
    },
    {
        number: "第四籤", title: "下籤 船行遇風", verse: "風狂雨驟急須防，船破槳折難進港。若問前途何處去，此去定然有驚慌。",
        interpretation: "此籤警示目前環境不利，須極度謹慎。**事業：** 危機重重，不宜進行任何重大改變或擴張，宜退守。**財運：** 有破財風險，投資宜立即停止。**婚姻：** 感情關係不穩定，易生爭吵或變故。**健康：** 須立即就醫檢查，注意心血管。**學業：** 壓力過大，需調整心態。**尋人：** 難尋，或情況不佳。**失物：** 難尋，已被人取走。",
        keywords: ['凶險', '危機', '困難', '下籤', '謹慎', '停止', '破財', '變故', '健康', '事業']
    },
    {
        number: "第五籤", title: "中吉 否極泰來", verse: "月老紅線兩手牽，喜鵲橋邊喜訊傳。事事如今漸順利，前途光景勝從前。",
        interpretation: "此籤為轉機之象，表示壞運已過，漸入佳境。**事業：** 困境解除，新的合作和項目將帶來轉機。**財運：** 逐漸穩定回升，適合小額投資。**婚姻：** 感情修成正果，或有喜事臨門。**健康：** 身體好轉，心情愉悅。**學業：** 學習環境改善，成績提升。**尋人：** 很快會回來。**失物：** 可找回，在西南方。",
        keywords: ['轉機', '中吉', '順利', '恢復', '喜訊', '婚姻', '事業', '財運', '健康', '機會']
    },
    {
        number: "第六籤", title: "中平 貴人指引", verse: "進退難決意彷徨，貴人指引有主張。雲開月出見分明，前途一片光明揚。",
        interpretation: "此籤提示您在困惑時應尋求外部幫助。**事業：** 面臨抉擇，多向長輩或專家請教，能做出正確決定。**財運：** 聽從理財顧問建議，避免盲目投資。**婚姻：** 雙方意見不合時，可尋求第三方協調。**健康：** 保持心情開朗，貴人幫助調整心態。**學業：** 聽取老師教誨，找到正確方法。**尋人：** 貴人能提供線索。**失物：** 需他人協助才能找到。",
        keywords: ['貴人', '指引', '抉擇', '彷徨', '請教', '協助', '光明', '中平', '決斷']
    },
    {
        number: "第七籤", title: "上吉 天賜良緣", verse: "天開地闊結良緣，千載一時此日全。占得此籤大吉利，百福駢臻萬事圓。",
        interpretation: "此籤為極佳吉籤，代表萬事順心，尤其利於婚戀。**事業：** 發展迅速，易得重要資源和合作夥伴。**財運：** 財運亨通，有意外之財。**婚姻：** 緣分已定，可速定婚期。**健康：** 身心狀態極佳，無憂無慮。**學業：** 輕易取得好成績。**尋人：** 立即相遇。**失物：** 必然尋回。",
        keywords: ['婚姻', '良緣', '大吉', '成功', '圓滿', '財運', '事業', '快速', '緣分', '喜事']
    },
    {
        number: "第八籤", title: "中下籤 守株待兔", verse: "日落烏啼半掩門，等閒空過一年春。勸君守舊方為吉，守株待兔實勞神。",
        interpretation: "此籤告誡不要空等，但也不宜輕舉妄動，宜守成。**事業：** 不宜開展新業務，守住現有成績為上策。**財運：** 收入持平，投資恐有失誤，不宜冒險。**婚姻：** 感情缺乏主動性，關係停滯不前。**健康：** 身體略顯疲憊，需主動調理。**學業：** 學習效率低下，需改變方法。**尋人：** 暫無歸期。**失物：** 難尋，已錯失良機。",
        keywords: ['守舊', '等待', '不宜動', '勞神', '停滯', '中下籤', '保守', '改變', '財運', '事業']
    },
    {
        number: "第九籤", title: "中吉 春風化雨", verse: "春風吹起柳絲長，和氣盈門百事昌。時機一到自然發，不須辛苦自奔忙。",
        interpretation: "此籤喻示時運將至，自然順利。**事業：** 處於上升期，人際關係和諧，有助於業務擴展。**財運：** 財源廣進，來自正當渠道，積累穩定。**婚姻：** 感情和睦，適合談婚論嫁。**健康：** 身心皆安，心情舒暢。**學業：** 輕鬆應對，發揮穩定。**尋人：** 不久將歸。**失物：** 有望不勞而獲。",
        keywords: ['順利', '中吉', '和睦', '上升', '擴展', '財運', '婚姻', '輕鬆', '自然', '春天']
    },
    {
        number: "第十籤", title: "中下籤 迷途知返", verse: "路險山高步步難，羊腸小徑不宜行。倘能迷途知回轉，自有無災保平安。",
        interpretation: "此籤警示目前方向錯誤，必須及時回頭。**事業：** 正在做的事情可能並非長久之計，宜重新審視方向。**財運：** 投資方向錯誤，應立即止損。**婚姻：** 關係陷入僵局，需誠實溝通或考慮暫時分開。**健康：** 需徹底改變不良習慣。**學業：** 學習方式有誤，應請教他人。**尋人：** 已走上岔路。**失物：** 無法找回，應視為教訓。",
        keywords: ['困難', '迷途', '回轉', '止損', '改變', '中下籤', '謹慎', '錯誤', '事業', '健康']
    },
    {
        number: "第十一籤", title: "中吉 鏡花水月", verse: "鏡花水月空自忙，竹籃打水一場空。若問何時得成就，靜待雲開見月明。",
        interpretation: "此籤提示目前所追求的目標可能虛幻，需調整心態和方向。**事業：** 努力付出與回報不成正比，應重新評估目標的可行性。**財運：** 避免投機和高風險項目，否則容易空手而歸。**婚姻：** 感情發展可能不切實際，需面對現實。**健康：** 注意失眠和壓力。**學業：** 學習效率不高，需專注於基礎。**尋人：** 消息虛假。**失物：** 難以追回。",
        keywords: ['虛幻', '空', '等待', '調整', '壓力', '事業', '財運', '中吉', '不切實際', '耐心']
    },
    {
        number: "第十二籤", title: "上吉 日出東方", verse: "日出東方萬里紅，前途光景盡亨通。財源滾滾如潮湧，占此必是福祿宏。",
        interpretation: "此籤為極佳吉兆，預示著一切將光明順利。**事業：** 充滿朝氣，是拓展市場和建立新項目的大好時機。**財運：** 財運極旺，投資回報豐厚。**婚姻：** 關係甜蜜，適合舉辦喜事。**健康：** 精力充沛，健康無憂。**學業：** 考運極佳，成績優異。**尋人：** 即將歸來。**失物：** 順利尋回。",
        keywords: ['大吉', '光明', '亨通', '事業', '財運', '婚姻', '機會', '成功', '拓展', '迅速']
    },
    {
        number: "第十三籤", title: "中平 靜水流深", verse: "靜水流深不見波，君子行事要低調。一帆風順無風險，福祿壽喜自相招。",
        interpretation: "此籤教導謙遜和低調是成功之道。**事業：** 雖然進展順利，但應避免鋒芒太露，以免招人妒忌。**財運：** 收入穩定增長，但勿向外透露。**婚姻：** 感情深厚，但宜保持平靜，不炫耀。**健康：** 保持規律生活，身心平和。**學業：** 默默耕耘，成績會顯現。**尋人：** 已經在安全地方。**失物：** 在家中的隱蔽處。",
        keywords: ['低調', '謙遜', '穩定', '順利', '靜水', '平靜', '中平', '事業', '財運', '安穩']
    },
    {
        number: "第十四籤", title: "中下籤 緣淺緣薄", verse: "花開花落總無情，人情冷暖世態輕。勸君不必多勞心，緣淺緣薄難共鳴。",
        interpretation: "此籤提示緣分或關係的短暫與不確定性。**事業：** 合作夥伴可能無法長久，專注於個人能力提升。**財運：** 財來財去，難以積聚。**婚姻：** 感情關係不穩定，易因誤會而分離。**健康：** 心情低落，影響身體，需自我調節。**學業：** 缺乏學習動力，需找到興趣。**尋人：** 緣分已盡，難再見。**失物：** 難尋，不必強求。",
        keywords: ['緣淺', '分離', '不穩', '短暫', '中下籤', '勞心', '感情', '合作', '財來財去']
    },
    {
        number: "第十五籤", title: "中吉 登山越嶺", verse: "登山越嶺步步高，雲霧撥開見光毫。莫謂前途多阻滯，自有神力暗中扶。",
        interpretation: "此籤喻示努力終有回報，困難只是暫時的考驗。**事業：** 雖然過程艱辛，但每一步的努力都會帶來提升和進步。**財運：** 收入隨著地位和能力的提升而增加。**婚姻：** 共同經歷困難後，感情更堅固。**健康：** 多運動有助於身體恢復。**學業：** 只要堅持，一定能克服難關。**尋人：** 正沿著路途歸來。**失物：** 在高處或山邊。",
        keywords: ['努力', '進步', '提升', '困難', '考驗', '中吉', '事業', '學業', '堅持', '回報']
    },
    {
        number: "第十六籤", title: "中平 一念之差", verse: "人情好惡只一時，莫因意氣失良機。只須心平無雜念，一念之差禍自離。",
        interpretation: "此籤提醒心態決定成敗，切勿意氣用事。**事業：** 避免與人發生爭執，平和處事才能把握良機。**財運：** 勿因一時衝動進行大額交易。**婚姻：** 感情穩定，但須克制情緒，避免口舌之爭。**健康：** 心情平靜是養生之道。**學業：** 專心一致，不受外界干擾。**尋人：** 已經在附近。**失物：** 很快可以找到，在西南方。",
        keywords: ['心態', '平和', '意氣', '避免', '爭執', '良機', '中平', '克制', '專注']
    },
    {
        number: "第十七籤", title: "中吉 猛虎出林", verse: "猛虎出林威勢壯，一聲長嘯動山崗。從今開始無阻礙，任君發揮展才能。",
        interpretation: "此籤為積極行動的信號，表示障礙已被清除。**事業：** 宜主動出擊，把握時機，展示領導力，會有突破性進展。**財運：** 財運強勁，適合積極投資和擴大業務。**婚姻：** 感情發展迅速，充滿激情和決心。**健康：** 體能達到巔峰。**學業：** 學習效率極高，能超越競爭者。**尋人：** 很快會出現。**失物：** 可迅速尋回。",
        keywords: ['積極', '行動', '突破', '威勢', '發展', '中吉', '事業', '財運', '迅速', '領導力']
    },
    {
        number: "第十八籤", title: "中下籤 緣木求魚", verse: "緣木求魚實可哀，此路不通早應開。縱然花費千般力，終究無功空手回。",
        interpretation: "此籤明確指出方向錯誤，付出再多也無濟於事。**事業：** 目前的策略或項目是錯誤的，應及時調整方向，避免浪費資源。**財運：** 投資標的錯誤，應果斷止損，尋求專業意見。**婚姻：** 感情投入無法得到回應，需理性評估關係。**健康：** 治療方式可能不對，需諮詢第二意見。**學業：** 方法無效，徒勞無功。**尋人：** 難尋，方向錯誤。**失物：** 不可能尋回。",
        keywords: ['錯誤', '無效', '徒勞', '停止', '中下籤', '財運', '事業', '調整', '浪費']
    },
    {
        number: "第十九籤", title: "上吉 金玉滿堂", verse: "金玉滿堂福祿全，榮華富貴得天然。佔得此籤事事好，家門和睦樂團圓。",
        interpretation: "此籤為財富和家庭和諧的吉兆。**事業：** 處於穩定成長和收穫期，名利雙收。**財運：** 財富積累快速且穩定，適合長期規劃。**婚姻：** 家庭和睦，關係幸福美滿。**健康：** 長久安康，身心愉悅。**學業：** 學習環境理想，成績穩定上升。**尋人：** 很快就會團聚。**失物：** 可在家庭範圍內尋回。",
        keywords: ['金玉', '財富', '家庭', '和睦', '穩定', '上吉', '事業', '收穫', '幸福', '長期']
    },
    {
        number: "第二十籤", title: "中平 困龍得水", verse: "困龍得水變化新，雲開月出見清明。前途有望皆如意，只待風雲際會時。",
        interpretation: "此籤喻示困境即將結束，轉機在望，但仍需等待啟動時機。**事業：** 之前的限制和阻礙將被解除，新的發展空間出現。**財運：** 資金回流，適合重新開始投資。**婚姻：** 誤會冰釋，關係恢復。**健康：** 舊疾好轉，恢復元氣。**學業：** 壓力減輕，學習效率提升。**尋人：** 很快會擺脫困境。**失物：** 有望找回。",
        keywords: ['困境', '解除', '轉機', '希望', '等待', '中平', '事業', '恢復', '冰釋', '風雲']
    },
    {
        number: "第二十一籤", title: "中吉 柳暗花明", verse: "柳暗花明又一村，山窮水盡不須愁。若能堅定向前進，自然有路通津頭。",
        interpretation: "此籤鼓勵在絕望時堅持，轉機就在眼前。**事業：** 遇到瓶頸時不要放棄，換個角度或方法會有新的出路。**財運：** 財務壓力大，但會找到新的收入來源。**婚姻：** 感情出現危機，但通過溝通能找到新的相處模式。**健康：** 保持樂觀，病情會出現轉折。**學業：** 突破學習障礙。**尋人：** 在意想不到的地方找到。**失物：** 在絕望時尋回。",
        keywords: ['瓶頸', '轉折', '柳暗花明', '堅持', '希望', '中吉', '出路', '溝通', '事業', '健康']
    },
    {
        number: "第二十二籤", title: "下籤 孤舟無援", verse: "孤舟無援在海中，浪急風高難從容。求神問卜徒增憂，不如自己靠自躬。",
        interpretation: "此籤警示目前處於孤立無援的狀態，不宜依賴他人。**事業：** 合作關係破裂，項目獨自承擔，壓力巨大。**財運：** 投資損失無法得到補償，應靠自己儲蓄。**婚姻：** 關係疏離，雙方缺乏支持。**健康：** 情況不佳，需主動尋求專業治療。**學業：** 只能依靠自學。**尋人：** 處境艱難，無法聯繫。**失物：** 難以找回。",
        keywords: ['孤立', '無援', '壓力', '艱難', '下籤', '獨自', '事業', '損失', '疏離', '自躬']
    },
    {
        number: "第二十三籤", title: "中平 潮起潮落", verse: "潮起潮落皆有時，月盈月虧豈無期。休將成敗論英雄，萬事循環從頭始。",
        interpretation: "此籤教導接受事物的規律和循環，不必執著於一時的得失。**事業：** 接受低潮期，準備迎接下一波高潮，穩定發展。**財運：** 收入有波動，保持平常心。**婚姻：** 關係經過起伏，最終趨於平靜。**健康：** 慢性病需長期調養。**學業：** 勿因一時成績波動而氣餒。**尋人：** 會在循環的某個時間點出現。**失物：** 難尋，但會以另一種方式補償。",
        keywords: ['循環', '規律', '平常心', '波動', '中平', '接受', '穩定', '長期', '事業', '財運']
    },
    {
        number: "第二十四籤", title: "上吉 百花齊放", verse: "百花齊放滿庭芳，萬紫千紅喜氣揚。占得此籤大吉利，處處皆是好風光。",
        interpretation: "此籤為大興旺、多方面成功的吉兆。**事業：** 多個項目或合作同時獲得成功，名聲大振。**財運：** 多元收入，財富快速增長。**婚姻：** 眾多選擇中找到佳偶，或家庭添丁。**健康：** 身體極佳，充滿生機。**學業：** 全面優秀，表現出色。**尋人：** 很快在熱鬧處出現。**失物：** 可迅速尋回。",
        keywords: ['成功', '多方面', '興旺', '大吉', '快速', '事業', '財富', '多元', '喜氣', '機會']
    },
    {
        number: "第二十五籤", title: "中下籤 枯木逢春", verse: "枯木逢春尚待時，眼前景物總淒迷。勸君不必多勞心，人事紛爭惹是非。",
        interpretation: "此籤警示雖然有恢復的可能，但過程緩慢且易有口舌爭議。**事業：** 項目重啟緩慢，需耐心處理人際糾紛。**財運：** 資金回籠慢，避免與人有借貸關係。**婚姻：** 感情容易因小事爭吵，需保持距離和空間。**健康：** 恢復期長，忌操勞。**學業：** 學習環境不佳，易受干擾。**尋人：** 暫時消息不確定。**失物：** 難尋，多因人為因素。",
        keywords: ['緩慢', '爭吵', '是非', '人際', '中下籤', '耐心', '恢復', '操勞', '事業', '健康']
    },
    {
        number: "第二十六籤", title: "中吉 否去泰來", verse: "否去泰來不用疑，花開結實正及時。占得此籤皆如意，財源廣進祿自隨。",
        interpretation: "此籤喻示壞運已盡，好運降臨，是收穫成果的時候。**事業：** 過去的努力現在開始產生回報，是簽訂合同的好時機。**財運：** 收入豐厚，可考慮新的投資佈局。**婚姻：** 關係穩定，適合邁入下一階段。**健康：** 身體狀態良好，精神煥發。**學業：** 成果顯著。**尋人：** 很快傳來好消息。**失物：** 立即找回。",
        keywords: ['收穫', '回報', '中吉', '簽約', '穩定', '財源', '事業', '成功', '及時', '努力']
    },
    {
        number: "第二十七籤", title: "中平 一葉知秋", verse: "一葉落知天下秋，萬事變化在心頭。不用勞心空計較，順應天時自無憂。",
        interpretation: "此籤教導順應自然規律，看清事物的發展趨勢。**事業：** 掌握市場變化，順勢而為，不必逆流而上。**財運：** 根據趨勢調整投資組合，保守為宜。**婚姻：** 關係發展順其自然，不強求。**健康：** 注意換季時節的保養。**學業：** 領悟力強，效率高。**尋人：** 情況變化很快。**失物：** 難以找回，順其自然。",
        keywords: ['順應', '變化', '規律', '保守', '心態', '中平', '事業', '趨勢', '領悟']
    },
    {
        number: "第二十八籤", title: "中下籤 緣淺難聚", verse: "長江後浪推前浪，新人勝舊舊人傷。莫問前緣今何在，緣淺難聚空惆悵。",
        interpretation: "此籤提示關係或時局的更迭，有分離和失落之意。**事業：** 競爭激烈，後起之秀不斷出現，需不斷學習和創新。**財運：** 資金流失，需注意投資風險。**婚姻：** 舊的關係難以維繫，或有新人介入，心境失落。**健康：** 情緒低落影響身體。**學業：** 學習壓力大，注意比較心態。**尋人：** 難再相見。**失物：** 不可復得。",
        keywords: ['分離', '更迭', '競爭', '失落', '中下籤', '創新', '學習', '婚姻', '財運']
    },
    {
        number: "第二十九籤", title: "上吉 春暖花開", verse: "春暖花開萬物生，雨露滋潤百業興。占得此籤時運到，發達亨通喜盈門。",
        interpretation: "此籤為百業興旺，機運成熟的吉兆。**事業：** 處於最佳發展期，適合啟動大項目和擴大團隊。**財運：** 財運旺盛，投資順利，收入翻倍。**婚姻：** 感情穩定，適合結婚或生育。**健康：** 身體強壯，充滿活力。**學業：** 靈感不斷，輕鬆達標。**尋人：** 馬上相見。**失物：** 可迅速找回。",
        keywords: ['興旺', '大吉', '發展', '發達', '事業', '財運', '婚姻', '機運', '快速', '成功']
    },
    {
        number: "第三十籤", title: "中平 雲遮月影", verse: "雲遮月影夜漫漫，獨自徘徊在江邊。勸君不必多憂慮，撥開雲霧見青天。",
        interpretation: "此籤喻示雖然目前處於迷茫或困境，但只是暫時的。**事業：** 項目進展不明確，多與資深人士溝通，很快能找到突破口。**財運：** 財務狀況有些混亂，宜整理賬目。**婚姻：** 感情出現誤會，需主動解釋。**健康：** 保持樂觀，憂慮是健康大敵。**學業：** 學習缺乏方向感。**尋人：** 很快有確切消息。**失物：** 在家中陰暗處。",
        keywords: ['迷茫', '暫時', '困境', '憂慮', '溝通', '中平', '整理', '解釋', '希望']
    },
    {
        number: "第三十一籤", title: "中吉 鯉魚化龍", verse: "鯉魚化龍躍龍門，一躍衝霄變不凡。從此事業皆如意，名利雙收天下傳。",
        interpretation: "此籤預示重大的轉變和成功，地位或身份將發生質的飛躍。**事業：** 將迎來重要突破，職位高升，獲得業界認可。**財運：** 收入和地位同步提升，財運極佳。**婚姻：** 關係將有一個飛躍性的發展，得到親友祝福。**健康：** 身體狀態極佳，充滿能量。**學業：** 考上理想學校或獲得重要證書。**尋人：** 將以全新的身份出現。**失物：** 難以找回，但會有更好的替代。",
        keywords: ['轉變', '成功', '飛躍', '升職', '名利', '中吉', '事業', '學業', '財運', '突破']
    },
    {
        number: "第三十二籤", title: "下籤 落花流水", verse: "落花流水總無情，人面不知何處尋。勸君回頭莫貪戀，徒勞無功損精神。",
        interpretation: "此籤警示失意和徒勞，應學會放手。**事業：** 項目失敗或合作破裂，不宜強行挽回，應果斷放手。**財運：** 資金流失嚴重，不宜再追加投入。**婚姻：** 感情已無法挽回，不宜執著。**健康：** 精神受創，導致身體虛弱。**學業：** 努力方向錯誤。**尋人：** 難以找回，關係已變。**失物：** 徹底失去。",
        keywords: ['失敗', '破裂', '放手', '徒勞', '下籤', '損失', '精神', '虛弱', '執著']
    },
    {
        number: "第三十三籤", title: "中平 孤雁離群", verse: "孤雁離群獨自飛，前途渺茫兩相違。若問何時得相聚，等到蘆花滿地時。",
        interpretation: "此籤喻示目前處於孤獨和迷茫狀態，但這是暫時的。**事業：** 缺乏合作夥伴，獨自奮鬥，感到壓力。**財運：** 只能依靠個人收入，積累緩慢。**婚姻：** 感情關係有隔閡或遠距離，相聚困難。**健康：** 注意情緒低落和抑鬱傾向。**學業：** 適合獨立研究。**尋人：** 在遠方，暫時不會回來。**失物：** 難尋，在偏僻處。",
        keywords: ['孤獨', '獨自', '迷茫', '壓力', '暫時', '中平', '緩慢', '遠距離', '情緒']
    },
    {
        number: "第三十四籤", title: "中吉 乘風破浪", verse: "乘風破浪濟滄海，一帆風順自無憂。占得此籤皆大吉，財源滾滾不用求。",
        interpretation: "此籤為積極順利的吉兆，形容充滿信心和能力去達成目標。**事業：** 處於強勁的發展勢頭，可以大膽推進計劃。**財運：** 收入穩定且豐厚，適合擴大投資規模。**婚姻：** 感情關係進展順利，目標一致。**健康：** 身體強健，精力旺盛。**學業：** 學習狀態極佳，自信滿滿。**尋人：** 乘興而歸。**失物：** 很快在水邊或交通工具上尋回。",
        keywords: ['順利', '中吉', '信心', '大膽', '推進', '事業', '財運', '強勁', '目標']
    },
    {
        number: "第三十五籤", title: "上吉 明月當空", verse: "明月當空照四方，光芒萬丈耀輝煌。占得此籤萬事好，貴人指引更無妨。",
        interpretation: "此籤喻示光明普照，一切順遂，且有貴人相助。**事業：** 發展清晰，目標明確，能獲得高層或重要人物的賞識和幫助。**財運：** 收入穩定且來源光明，財富增長迅速。**婚姻：** 關係公開透明，得到親友支持。**健康：** 身體無恙，心境開闊。**學業：** 智慧開啟，學有所成。**尋人：** 貴人會引導相見。**失物：** 可迅速尋回，在顯眼處。",
        keywords: ['光明', '貴人', '指引', '清晰', '上吉', '事業', '財富', '支持', '成功', '迅速']
    },
    {
        number: "第三十六籤", title: "中下籤 雨過天晴", verse: "雨過天青雲未散，風吹浪打尚未平。若問前途何時好，還須等到月圓盈。",
        interpretation: "此籤提示困難已經過去，但仍需要一段時間才能完全恢復。**事業：** 危機解除，但市場尚未完全穩定，宜保持謹慎和觀察。**財運：** 損失已停止，但資金回籠緩慢。**婚姻：** 爭吵結束，但關係仍需時間修復。**健康：** 恢復期長，需要靜養。**學業：** 雖然有進步，但仍需努力。**尋人：** 消息不確定，需等待時機。**失物：** 難尋，需花費時間。",
        keywords: ['恢復', '緩慢', '等待', '謹慎', '觀察', '中下籤', '時間', '修復', '靜養']
    },
    {
        number: "第三十七籤", title: "中平 鶴立雞群", verse: "鶴立雞群眾不同，智慧超群名利榮。只因才華太出眾，恐有小人暗中攻。",
        interpretation: "此籤喻示才華出眾，但需提防妒忌和小人。**事業：** 表現突出，容易被器重，但也易受同事排擠，宜謙遜。**財運：** 收入優於常人，但需低調處理。**婚姻：** 感情受外界干擾，需堅定立場。**健康：** 注意因壓力引起的焦慮。**學業：** 表現優異，但需警惕競爭者。**尋人：** 在人群中很顯眼。**失物：** 被小人藏匿，難以尋回。",
        keywords: ['才華', '出眾', '小人', '妒忌', '謙遜', '中平', '事業', '壓力', '警惕']
    },
    {
        number: "第三十八籤", title: "中吉 緣分注定", verse: "前世因緣今生聚，月老紅線早已牽。不須勞心空計較，緣分注定美滿全。",
        interpretation: "此籤強調緣分的不可抗拒性，一切都是最好的安排。**事業：** 合作夥伴是注定的貴人，應珍惜。**財運：** 財源來自於既有的關係或合作。**婚姻：** 緣定三生，感情自然而然會走向美滿。**健康：** 心態平和，順其自然。**學業：** 學習是天賦的展現。**尋人：** 很快在宿命的安排下相遇。**失物：** 難以找回，但可能是命中註定要失去。",
        keywords: ['緣分', '注定', '美滿', '合作', '婚姻', '中吉', '順其自然', '平和', '珍惜']
    },
    {
        number: "第三十九籤", title: "中下籤 山高水遠", verse: "山高水遠路難行，進退兩難心不定。勸君駐足莫強求，退守保平安為上。",
        interpretation: "此籤警示前路艱難，不宜強行推進，應暫時停止。**事業：** 目標難以達成，應縮減規模，避免損失。**財運：** 資金鏈可能緊張，不宜借貸或投資。**婚姻：** 關係出現危機，宜暫時冷靜分開，不要強求。**健康：** 需長途跋涉或勞心，注意身體。**學業：** 難以專心致志。**尋人：** 距離遙遠，歸期未定。**失物：** 難以找回。",
        keywords: ['艱難', '停止', '退守', '中下籤', '損失', '冷靜', '危機', '事業', '財運']
    },
    {
        number: "第四十籤", title: "中吉 和氣生財", verse: "和氣生財是真理，家中老幼盡歡顏。若問財源何處有，只在笑語談笑間。",
        interpretation: "此籤強調家庭和睦與良好的人際關係帶來財富和順利。**事業：** 應重視團隊合作和客戶關係，以和為貴。**財運：** 財源來自人脈和關係，通過合作獲得。**婚姻：** 關係和睦，家庭是最大的支持。**健康：** 心情愉悅，自然健康。**學業：** 在集體討論中獲得進步。**尋人：** 很快在聚會中出現。**失物：** 在家中找到。",
        keywords: ['和睦', '人際', '合作', '財源', '支持', '中吉', '家庭', '事業', '愉悅']
    },
    {
        number: "第四十一籤", title: "中平 一時糊塗", verse: "一時糊塗心不定，錯把魚目當珍珠。幸有貴人來指點，方知此寶價不同。",
        interpretation: "此籤警示因一時判斷失誤而犯錯，但有機會得到指正。**事業：** 誤判了項目價值，需虛心接受前輩的意見。**財運：** 投資失誤，需及時止損，聽從專業建議。**婚姻：** 錯愛或誤會，有貴人介入幫助釐清。**健康：** 因判斷失誤延誤治療。**學業：** 選錯專業或方向。**尋人：** 貴人能找到線索。**失物：** 已錯過最好的尋找時機。",
        keywords: ['失誤', '糊塗', '貴人', '指點', '釐清', '中平', '判斷', '事業', '投資']
    },
    {
        number: "第四十二籤", title: "上吉 撥雲見日", verse: "撥開雲霧見青天，積壓已久事得宣。從今開始多順利，事事如意喜連連。",
        interpretation: "此籤喻示長久的困境或冤屈終獲解決，前景一片光明。**事業：** 糾紛解決，項目可以重新啟動並順利發展。**財運：** 積壓的欠款或收益得以回籠。**婚姻：** 誤會解除，關係重修舊好。**健康：** 困擾已久的舊疾將會好轉。**學業：** 難題迎刃而解。**尋人：** 消息公開透明。**失物：** 很快找回。",
        keywords: ['解決', '順利', '光明', '上吉', '事業', '財運', '恢復', '喜悅', '重啟']
    },
    {
        number: "第四十三籤", title: "中下籤 風中燈火", verse: "風中燈火搖曳時，忽明忽滅難支持。問君如何保平安，堅守本心莫變移。",
        interpretation: "此籤警示環境變動劇烈，個人力量難以抵抗，需堅守原則。**事業：** 市場極不穩定，不宜擴張或冒險，固守現狀。**財運：** 收入不穩定，需保守理財，避免投機。**婚姻：** 感情關係脆弱，易受外界影響，需堅定信念。**健康：** 情緒波動大，導致身體不適。**學業：** 專注力分散。**尋人：** 情況危急，需儘快尋求幫助。**失物：** 難以找回。",
        keywords: ['不穩', '脆弱', '變動', '堅守', '保守', '中下籤', '事業', '財運', '情緒']
    },
    {
        number: "第四十四籤", title: "中吉 守得雲開", verse: "守得雲開見月明，枯木逢春再發榮。此時進退皆如意，謀望求財總稱心。",
        interpretation: "此籤喻示經過漫長等待後，終於迎來成功的時機。**事業：** 之前停滯的項目可以重新啟動，且將順利。**財運：** 資金回籠，收益超出預期。**婚姻：** 關係經歷考驗後更加堅固。**健康：** 舊疾完全康復。**學業：** 努力終得回報。**尋人：** 很快歸來。**失物：** 可找回。",
        keywords: ['等待', '成功', '時機', '恢復', '中吉', '事業', '財運', '重新', '順利']
    },
    {
        number: "第四十五籤", title: "中平 踏實耕耘", verse: "一分耕耘一分收，不必妄想空計謀。若是勤力加努力，福祿自然不遠求。",
        interpretation: "此籤教導踏實努力，不投機取巧，靠實力獲得成功。**事業：** 成功來自日常的積累和努力，沒有捷徑。**財運：** 收入與付出成正比，不宜妄想暴利。**婚姻：** 關係需細心經營，日久見人心。**健康：** 透過運動和規律飲食維護健康。**學業：** 紮實基礎是關鍵。**尋人：** 訊息需一步步核實。**失物：** 難以找回，是因疏忽所致。",
        keywords: ['踏實', '努力', '積累', '實力', '耕耘', '中平', '事業', '健康', '經營']
    },
    {
        number: "第四十六籤", title: "中吉 小人遠離", verse: "小人遠離君子近，是非紛爭自不聞。前途坦蕩無限好，舉步高昇更超群。",
        interpretation: "此籤喻示人際環境將得到淨化，有貴人相助，發展順利。**事業：** 內部環境改善，得到重要人物支持，發展空間擴大。**財運：** 避免了因小人導致的破財風險，收入穩定。**婚姻：** 關係不受外界干擾，專注於兩人世界。**健康：** 心情舒暢，遠離煩惱。**學業：** 專心致志，成績突出。**尋人：** 很快在友善的環境中找到。**失物：** 難尋，多因人為。",
        keywords: ['小人', '遠離', '貴人', '淨化', '順利', '中吉', '事業', '人際', '提升']
    },
    {
        number: "第四十七籤", title: "下籤 守口如瓶", verse: "口舌是非日日有，無心之言惹禍端。勸君守口要如瓶，是非爭議自然散。",
        interpretation: "此籤警示口舌是非帶來的風險，需謹言慎行。**事業：** 避免評論他人，專注於自己的工作，否則易捲入辦公室政治。**財運：** 避免與人合夥或保證，遠離是非。**婚姻：** 爭吵多由言辭不慎引起，需控制情緒。**健康：** 易因上火或壓力導致口腔問題。**學業：** 專心聽講，少與人爭辯。**尋人：** 消息混亂，無法確定。**失物：** 難尋，多因人際糾紛。",
        keywords: ['是非', '口舌', '爭議', '謹言', '下籤', '避免', '爭吵', '事業', '人際']
    },
    {
        number: "第四十八籤", title: "中平 順水行舟", verse: "順水行舟自無憂，不必勞心空計謀。前途自有神明佑，一切皆從自然流。",
        interpretation: "此籤教導順應大勢，不必過度操心，順其自然即可。**事業：** 抓住目前的良好趨勢，自然能順利推進，避免畫蛇添足。**財運：** 投資跟隨市場大勢，保守為宜。**婚姻：** 關係穩定，不需刻意經營，順其自然發展。**健康：** 保持規律生活，身心安適。**學業：** 找到適合自己的節奏。**尋人：** 很快在順利的環境中找到。**失物：** 可找回，在河流或水邊。",
        keywords: ['順應', '自然', '穩定', '保守', '趨勢', '中平', '事業', '生活', '節奏']
    },
    {
        number: "第四十九籤", title: "中吉 否極泰來", verse: "否極泰來不用疑，困苦艱辛總過去。從今開始運氣轉，一帆風順自如意。",
        interpretation: "此籤明確表示所有的困境已結束，好運即將到來。**事業：** 限制解除，項目將會加速推進，獲得成功。**財運：** 過去的虧損將得到彌補，資金回籠。**婚姻：** 關係中的矛盾消除，重新開始。**健康：** 身體完全恢復元氣。**學業：** 學習效率和成果大幅提高。**尋人：** 擺脫困境歸來。**失物：** 可找回，且會帶來驚喜。",
        keywords: ['困境', '結束', '轉運', '恢復', '成功', '中吉', '事業', '財運', '加速', '彌補']
    },
    {
        number: "第五十籤", title: "下籤 守成安份", verse: "日出月落幾多時，勸君守成分安居。若問前途何時好，須待猴子脫袍衣。",
        interpretation: "此籤警示目前不宜冒險，宜安分守己，等待變革的時機。**事業：** 避免任何變動或擴張，守住現有市場和客戶。**財運：** 收入穩定，但不宜有任何投資投機行為。**婚姻：** 關係平淡，缺乏激情，宜保持現狀。**健康：** 容易疲勞，需保持規律生活。**學業：** 成績平穩，缺乏突破。**尋人：** 難尋，需等待特殊時機。**失物：** 難以找回，是因貪心所致。",
        keywords: ['守成', '安分', '等待', '不宜動', '平穩', '下籤', '事業', '財運', '規律', '疲勞']
    },
    {
        number: "第五十一籤", title: "中平 謙受益滿招損", verse: "謙受益兮滿招損，戒之在心莫放縱。若問前途何處去，只須低頭莫逞能。",
        interpretation: "此籤教導謙虛的重要性，提醒避免自滿和驕傲。**事業：** 順利時更要保持低調，聽取不同的意見，避免獨斷。**財運：** 收入穩定，切勿炫耀，以免引起不必要的風險。**婚姻：** 關係中保持謙讓，避免爭強好勝。**健康：** 保持平和心態。**學業：** 謙虛向學，避免驕傲。**尋人：** 保持低調才能找到。**失物：** 難以找回，是因疏忽。",
        keywords: ['謙虛', '低調', '自滿', '避免', '中平', '事業', '財運', '謙讓', '平和']
    },
    {
        number: "第五十二籤", title: "中吉 福德綿長", verse: "福德綿長天自佑，行善積德喜無憂。若問前程皆順利，一切成就不用愁。",
        interpretation: "此籤強調品德和善行帶來的福報，一切皆在神明庇佑之下。**事業：** 事業順利，貴人多助，因平日積善而獲得良好聲譽。**財運：** 財源來自正道，收入穩定且富足。**婚姻：** 關係和睦，家庭幸福，因善緣而結。**健康：** 長久安康，身心平靜。**學業：** 學習成果源自勤奮。**尋人：** 善緣相助，很快找到。**失物：** 很快歸還。",
        keywords: ['福德', '行善', '順利', '庇佑', '中吉', '事業', '財運', '和睦', '安康', '貴人']
    },
    {
        number: "第五十三籤", title: "中下籤 虛花不實", verse: "虛花不實總難持，猶如海市蜃樓時。勸君早早知回頭，免得一場空歡喜。",
        interpretation: "此籤警示目標或事物虛假不實，應及時抽身。**事業：** 項目或合作可能是空頭支票，應仔細核實，避免浪費時間。**財運：** 投資項目過於美好，可能隱藏巨大風險，宜果斷撤資。**婚姻：** 感情發展基礎不牢固，應面對現實。**健康：** 藥物或治療方案可能無效。**學業：** 所學知識不實用。**尋人：** 消息虛假。**失物：** 徹底失去，一場空。",
        keywords: ['虛假', '不實', '撤資', '風險', '中下籤', '回頭', '浪費', '事業', '財運']
    },
    {
        number: "第五十四籤", title: "中平 舊瓶新酒", verse: "舊瓶新酒味不同，人事更迭意難通。勸君莫貪戀舊情，放下包袱向前衝。",
        interpretation: "此籤教導接受改變，放下過去的執著，迎接新的開始。**事業：** 舊的模式需要注入新元素，放下過去的成功經驗，創新發展。**財運：** 過去的投資方式已不適用，需調整策略。**婚姻：** 關係需要更新，放下舊日爭執。**健康：** 改變不良習慣。**學業：** 學習新知識和技術。**尋人：** 關係需要重新定義。**失物：** 難以找回，是為了讓您向前看。",
        keywords: ['改變', '創新', '放下', '舊情', '中平', '調整', '事業', '技術', '重新']
    },
    {
        number: "第五十五籤", title: "中吉 雙喜臨門", verse: "雙喜臨門樂無邊，求財謀望兩周全。若問婚姻和合事，天作之合美姻緣。",
        interpretation: "此籤為大吉之兆，預示多重喜事降臨，尤其利於婚戀。**事業：** 同時獲得兩個重要的成功或合作機會。**財運：** 收入來源增加，財富雙豐收。**婚姻：** 緣分極佳，是結婚或添丁的大好時機。**健康：** 身心愉悅，充滿福氣。**學業：** 考試或申請雙雙成功。**尋人：** 兩位同時歸來。**失物：** 找回一件，另一件也有好消息。",
        keywords: ['雙喜', '喜事', '婚姻', '合作', '財富', '中吉', '事業', '成功', '緣分', '周全']
    },
    {
        number: "第五十六籤", title: "中下籤 畫餅充飢", verse: "畫餅充飢不可為，徒勞無功自心悲。勸君早覓真糧食，莫在虛幻費力氣。",
        interpretation: "此籤警示目標不切實際或方法錯誤，應尋求實際的解決方案。**事業：** 項目只是空想，缺乏實際可行性，應立即調整。**財運：** 避免夢想暴富的投機行為，應腳踏實地。**婚姻：** 感情關係建立在幻想之上，缺乏現實基礎。**健康：** 尋求實際有效的治療。**學業：** 學習方法需要落地。**尋人：** 消息虛假。**失物：** 難以找回。",
        keywords: ['虛幻', '不實', '空想', '調整', '中下籤', '腳踏實地', '事業', '財運', '現實']
    },
    {
        number: "第五十七籤", title: "中平 危機警示", verse: "危機暗藏在順利，得意之時需警惕。凡事小心方為吉，樂極生悲悔已遲。",
        interpretation: "此籤提示在順利時更要保持警惕，不要得意忘形。**事業：** 發展順利，但需注意合同細節或潛在的法律風險。**財運：** 收入增加時，更要控制開支，避免高風險投資。**婚姻：** 關係穩定，但需避免因疏忽而產生矛盾。**健康：** 注意因飲食放縱導致的身體不適。**學業：** 保持謙虛。**尋人：** 很快會回來，但需注意安全。**失物：** 可找回，但可能隱藏危機。",
        keywords: ['危機', '警惕', '小心', '順利', '中平', '低調', '事業', '財運', '風險', '細節']
    },
    {
        number: "第五十八籤", title: "中吉 喜氣洋洋", verse: "喜氣洋洋樂開顏，前途如意事周全。財源廣進祿自來，吉星高照保安然。",
        interpretation: "此籤為歡樂和順利的吉兆，表示萬事皆在掌控之中。**事業：** 發展穩定且令人滿意，團隊合作愉快。**財運：** 收入穩定增長，財務狀況良好。**婚姻：** 關係和睦，適合社交和慶祝活動。**健康：** 身體強健，心情愉快。**學業：** 考運佳，成績突出。**尋人：** 很快在聚會中出現。**失物：** 可迅速找回。",
        keywords: ['喜悅', '順利', '穩定', '中吉', '事業', '財運', '和睦', '慶祝', '團隊']
    },
    {
        number: "第五十九籤", title: "中平 變通之道", verse: "變通之道活水來，死守舊法必生災。勸君審時度勢變，方能前行無阻礙。",
        interpretation: "此籤教導靈活應變，不能墨守成規，變則通。**事業：** 現有策略需要根據環境變化進行調整和創新。**財運：** 投資應靈活調整，分散風險，不能固執己見。**婚姻：** 關係需要不斷創新和溝通，避免僵化。**健康：** 改變生活習慣，尋求新的調理方式。**學業：** 學習方法需要多樣化。**尋人：** 需改變尋找方式。**失物：** 難以找回，是為了讓您改變。",
        keywords: ['變通', '創新', '調整', '靈活', '中平', '事業', '策略', '風險', '溝通']
    },
    {
        number: "第六十籤", title: "上吉 圓滿無缺", verse: "六十甲子盡循環，花開富貴喜相迎。萬事皆已圓滿矣，從此無憂樂太平。",
        interpretation: "此籤為最吉之籤，代表階段性的圓滿結束和完美開端。**事業：** 達到預期目標，可準備迎接更高層次的挑戰。**財運：** 財務狀況穩固，心境平和。**婚姻：** 關係有望走向美滿幸福的狀態。**健康：** 身體狀況佳，精神煥發。**學業：** 獲得良好的學術成就。**尋人：** 關係最終將獲得圓滿的結局。**失物：** 即使失去，也有更好的替代品出現，結局完美。",
        keywords: ['圓滿', '結束', '開始', '完美', '幸福', '最終', '最高', '太平', '挑戰', '富貴', '上吉', '無缺', '心想事成']
    }
];

// --- 匹配權重配置 ---
const WEIGHTS = {
    '事業': ['工作', '職位', '升職', '跳槽', '發展', '創業', '公司', '業務', '職場'],
    '財運': ['錢', '財富', '投資', '買房', '股票', '賺錢', '收入', '資金', '債務', '理財', '利潤'],
    '婚姻': ['姻緣', '愛情', '感情', '戀愛', '結婚', '復合', '對象', '緣分', '伴侶', '家庭', '關係'],
    '健康': ['病', '身體', '健康', '康復', '生病', '治療', '長壽', '平安', '檢查', '疾病'],
    '學業': ['考試', '學習', '成績', '深造', '留學', '讀書', '升學', '畢業', '論文', '學校'],
    '尋人': ['找人', '失蹤', '走失', '尋找', '歸來', '人在哪', '朋友', '親人'],
    '失物': ['丟', '不見', '失物', '找回', '遺失', '物品', '貴重'],
    
    '正面意圖': ['順利', '成功', '好嗎', '能', '可以', '是否', '快點', '何時', '開始', '有望', '得到'],
    '負面意圖': ['風險', '危機', '失敗', '不好', '怎麼辦', '停止', '難嗎', '避免', '結束', '會失去', '嚴重'],
};

// --- 全局變量 ---
let isDrawing = false;
let drawnStickData = null;
let currentAnimation = null;

// --- 工具函數 ---
/**
 * 安全的音效播放
 */
function safePlayAudio(audioId) {
    try {
        const audio = document.getElementById(audioId);
        if (audio) {
            audio.currentTime = 0;
            return audio.play().catch(e => {
                console.warn(`音效 ${audioId} 播放失敗:`, e);
                return Promise.resolve();
            });
        }
    } catch (error) {
        console.warn(`音效 ${audioId} 播放錯誤:`, error);
    }
    return Promise.resolve();
}

/**
 * 顯示加載動畫
 */
function showLoading() {
    const loading = document.getElementById('loading');
    if (loading) loading.style.display = 'flex';
}

/**
 * 隱藏加載動畫
 */
function hideLoading() {
    const loading = document.getElementById('loading');
    if (loading) loading.style.display = 'none';
}

/**
 * 生成確定性隨機數
 */
function seededRandom(seed) {
    let hash = 0;
    for (let i = 0; i < seed.length; i++) {
        const char = seed.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash |= 0;
    }
    
    let x = (hash * 0x7fffffff) & 0xfffffff;

    return function() {
        x = (x * 9301 + 49297) % 233280;
        return x / 233280;
    };
}

/**
 * 生成查詢種子
 */
function generateQuerySeed(query) {
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    
    const cleanQuery = query.trim().replace(/[^\w\s]/gi, '').toLowerCase();
    
    return { 
        queryKey: `fortune-${dateStr}-${cleanQuery.substring(0, 20)}`,
        seed: `${dateStr}:${cleanQuery}:jasyooc_v3`
    };
}

/**
 * 計算籤文分數
 */
function calculateStickScores(query) {
    const normalizedQuery = query.toLowerCase().replace(/\s/g, '');
    const scores = [];
    
    // 識別意圖
    let userIntent = '中性意圖';
    if (WEIGHTS['正面意圖'].some(word => normalizedQuery.includes(word))) {
        userIntent = '正面意圖';
    } else if (WEIGHTS['負面意圖'].some(word => normalizedQuery.includes(word))) {
        userIntent = '負面意圖';
    }
    
    // 計算每支籤分數
    fortuneSticks.forEach(stick => {
        let score = 0;
        
        // 關鍵詞匹配
        if (stick.keywords && Array.isArray(stick.keywords)) {
            stick.keywords.forEach(keyword => {
                if (normalizedQuery.includes(keyword.toLowerCase())) {
                    score += 10;
                }
            });
        }
        
        // 領域匹配
        Object.keys(WEIGHTS)
            .filter(k => k.length > 2 && !['正面意圖', '負面意圖'].includes(k))
            .forEach(field => {
                if (WEIGHTS[field].some(word => normalizedQuery.includes(word))) {
                    if (stick.keywords && stick.keywords.includes(field)) {
                        score += 15;
                    }
                }
            });
        
        // 意圖調整
        const isFavorable = stick.title.includes('上吉') || stick.title.includes('中吉');
        const isCautious = stick.title.includes('下籤') || stick.title.includes('中下籤');
        
        if (userIntent === '正面意圖') {
            score += isFavorable ? 20 : (isCautious ? -10 : 0);
        } else if (userIntent === '負面意圖') {
            score += isCautious ? 20 : (isFavorable ? -10 : 0);
        }
        
        scores.push({ ...stick, score: Math.max(1, score) });
    });
    
    return scores;
}

/**
 * 確定性選擇籤文
 */
function deterministicSelect(scoredSticks, nextRandom) {
    const totalScore = scoredSticks.reduce((sum, stick) => sum + stick.score, 0);
    if (totalScore === 0) return scoredSticks[0];
    
    let randomNum = nextRandom() * totalScore;
    
    for (const stick of scoredSticks) {
        randomNum -= stick.score;
        if (randomNum < 0) return stick;
    }
    
    return scoredSticks[scoredSticks.length - 1];
}

// --- SVG 繪製函數 ---
/**
 * 創建精美籤筒 SVG
 */
function createCenserSVG(width, height) {
    const baseColor = "#8b4513";
    const edgeColor = "#a0522d";
    const accentColor = "#d4a017";
    const goldColor = "#ffd700";
    
    const topRadius = width / 2;
    const bottomRadius = topRadius * 0.9;
    
    // 籤筒主體路徑（開口朝上）
    const bodyPath = `M ${width/2 - topRadius} ${height-20} 
                      L ${width/2 - bottomRadius} 20 
                      A ${bottomRadius} 6 0 0 0 ${width/2 + bottomRadius} 20 
                      L ${width/2 + topRadius} ${height-20} Z`;
    
    return `
        <svg class="censer" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
            <defs>
                <linearGradient id="censerGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#a0522d;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#8b4513;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#654321;stop-opacity:1" />
                </linearGradient>
                
                <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#ffd700;stop-opacity:0.8" />
                    <stop offset="100%" style="stop-color:#ffed4e;stop-opacity:0.9" />
                </linearGradient>
                
                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="3" result="blur"/>
                    <feMerge>
                        <feMergeNode in="blur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
                
                <pattern id="woodPattern" patternUnits="userSpaceOnUse" width="20" height="20">
                    <path d="M0,0 L20,20 M20,0 L0,20" stroke="#5d4037" stroke-width="0.5" opacity="0.2"/>
                </pattern>
            </defs>
            
            <!-- 籤筒陰影 -->
            <ellipse cx="${width/2}" cy="${height-10}" rx="${topRadius+5}" ry="10" fill="#000" opacity="0.2" filter="url(#glow)"/>
            
            <!-- 籤筒主體 -->
            <g filter="url(#glow)">
                <path d="${bodyPath}" fill="url(#censerGradient)" stroke="${edgeColor}" stroke-width="3"/>
                
                <!-- 木紋效果 -->
                <path d="${bodyPath}" fill="url(#woodPattern)" opacity="0.3"/>
                
                <!-- 裝飾邊框 -->
                <ellipse cx="${width/2}" cy="${height-20}" rx="${topRadius}" ry="10" fill="none" stroke="${goldColor}" stroke-width="2" opacity="0.8"/>
                <ellipse cx="${width/2}" cy="20" rx="${bottomRadius}" ry="8" fill="none" stroke="${goldColor}" stroke-width="2" opacity="0.8"/>
                
                <!-- 中間裝飾線 -->
                <ellipse cx="${width/2}" cy="${height/2}" rx="${topRadius*0.85}" ry="4" fill="none" stroke="${accentColor}" stroke-width="1.5" opacity="0.6"/>
                
                <!-- 裝飾圖案 -->
                <g opacity="0.4">
                    <path d="M ${width/2-25} ${height/2-30} Q ${width/2} ${height/2-40} ${width/2+25} ${height/2-30}" 
                          fill="none" stroke="${goldColor}" stroke-width="1"/>
                    <path d="M ${width/2-20} ${height/2+30} Q ${width/2} ${height/2+40} ${width/2+20} ${height/2+30}" 
                          fill="none" stroke="${goldColor}" stroke-width="1"/>
                </g>
            </g>
            
            <!-- 頂部裝飾環 -->
            <rect x="${width/2-topRadius}" y="${height-25}" width="${topRadius*2}" height="8" rx="4" fill="#654321" opacity="0.9"/>
            
            <!-- "知遇籤"文字容器 -->
            <rect x="${width/2-55}" y="${height/2-45}" width="110" height="90" rx="15" 
                  fill="rgba(255, 255, 255, 0.1)" 
                  stroke="rgba(255, 215, 0, 0.3)" 
                  stroke-width="1.5"
                  filter="url(#glow)"/>
            
            <!-- 文字陰影 -->
            <text x="${width/2}" y="${height/2-15}" 
                  font-family="'Noto Serif TC', serif"
                  font-size="22"
                  font-weight="900"
                  fill="#000"
                  text-anchor="middle"
                  opacity="0.3"
                  filter="url(#glow)">
                知
            </text>
            <text x="${width/2}" y="${height/2+5}" 
                  font-family="'Noto Serif TC', serif"
                  font-size="22"
                  font-weight="900"
                  fill="#000"
                  text-anchor="middle"
                  opacity="0.3"
                  filter="url(#glow)">
                遇
            </text>
            <text x="${width/2}" y="${height/2+25}" 
                  font-family="'Noto Serif TC', serif"
                  font-size="22"
                  font-weight="900"
                  fill="#000"
                  text-anchor="middle"
                  opacity="0.3"
                  filter="url(#glow)">
                籤
            </text>
            
            <!-- 金色文字 -->
            <text x="${width/2}" y="${height/2-15}" 
                  font-family="'Noto Serif TC', serif"
                  font-size="22"
                  font-weight="900"
                  fill="url(#goldGradient)"
                  text-anchor="middle"
                  text-shadow="0 0 10px rgba(255, 215, 0, 0.7)"
                  opacity="0.95">
                知
            </text>
            <text x="${width/2}" y="${height/2+5}" 
                  font-family="'Noto Serif TC', serif"
                  font-size="22"
                  font-weight="900"
                  fill="url(#goldGradient)"
                  text-anchor="middle"
                  text-shadow="0 0 10px rgba(255, 215, 0, 0.7)"
                  opacity="0.95">
                遇
            </text>
            <text x="${width/2}" y="${height/2+25}" 
                  font-family="'Noto Serif TC', serif"
                  font-size="22"
                  font-weight="900"
                  fill="url(#goldGradient)"
                  text-anchor="middle"
                  text-shadow="0 0 10px rgba(255, 215, 0, 0.7)"
                  opacity="0.95">
                籤
            </text>
            
            <!-- 裝飾光點 -->
            <circle cx="${width/2-40}" cy="${height/2-35}" r="2" fill="${goldColor}" opacity="0.6" filter="url(#glow)"/>
            <circle cx="${width/2+40}" cy="${height/2-35}" r="2" fill="${goldColor}" opacity="0.6" filter="url(#glow)"/>
            <circle cx="${width/2-40}" cy="${height/2+35}" r="2" fill="${goldColor}" opacity="0.6" filter="url(#glow)"/>
            <circle cx="${width/2+40}" cy="${height/2+35}" r="2" fill="${goldColor}" opacity="0.6" filter="url(#glow)"/>
        </svg>
    `;
}

/**
 * 初始化抽籤區域
 */
function initializeDrawing() {
    const drawArea = document.getElementById('draw-area');
    
    let svgContent = `
        <svg id="main-svg" width="320" height="500" viewBox="0 0 320 500" style="overflow: visible;">
            <!-- 背景裝飾 -->
            <defs>
                <radialGradient id="bgGradient" cx="50%" cy="50%" r="80%">
                    <stop offset="0%" stop-color="#f9f5eb" stop-opacity="0.9"/>
                    <stop offset="50%" stop-color="#f5f0e3" stop-opacity="0.7"/>
                    <stop offset="100%" stop-color="#f0e6d6" stop-opacity="0.5"/>
                </radialGradient>
                
                <filter id="softShadow">
                    <feDropShadow dx="0" dy="8" stdDeviation="5" flood-color="#000" flood-opacity="0.15"/>
                </filter>
            </defs>
            
            <!-- 背景 -->
            <rect width="100%" height="100%" fill="url(#bgGradient)"/>
            
            <!-- 背景祥雲 -->
            <g opacity="0.08">
                <path d="M40,80 Q60,60 80,80 T120,80" fill="none" stroke="#8b4513" stroke-width="3"/>
                <path d="M220,120 Q240,100 260,120 T300,120" fill="none" stroke="#8b4513" stroke-width="3"/>
                <path d="M80,350 Q100,330 120,350 T160,350" fill="none" stroke="#8b4513" stroke-width="3"/>
            </g>
            
            <!-- 筒內籤文 -->
            <g id="sticks-in-censer">`;
    
    // 繪製20支籤
    const stickCount = 20;
    for (let i = 0; i < stickCount; i++) {
        const angle = (i - stickCount/2) * 0.15;
        const offsetX = Math.sin(angle) * 30;
        const stickX = 160 + offsetX + (i - stickCount/2) * 1.5;
        const stickY = 100;
        const stickHeight = 200 + Math.random() * 30;
        const stickColor = i % 4 === 0 ? '#f5deb3' : 
                          i % 4 === 1 ? '#e6b36a' : 
                          i % 4 === 2 ? '#d4a017' : '#b8860b';
        
        svgContent += `
            <rect class="stick-in-censer" data-index="${i}"
                  x="${stickX - 4}" y="${stickY}"
                  width="8" height="${stickHeight}"
                  rx="3"
                  fill="${stickColor}"
                  stroke="#8b4513"
                  stroke-width="1.2"
                  opacity="0.9"
                  transform="rotate(${angle * 2}, ${stickX}, ${stickY})"
                  style="transition: all 0.5s ease"/>
        `;
    }
    
    svgContent += `
            </g>
            
            <!-- 籤筒 -->
            ${createCenserSVG(200, 350).replace('<svg', `<svg x="60" y="80" id="censer-svg-group"`)}
            
            <!-- 底座 -->
            <g filter="url(#softShadow)">
                <ellipse cx="160" cy="450" rx="120" ry="20" fill="#654321" opacity="0.8"/>
                <ellipse cx="160" cy="450" rx="100" ry="15" fill="#8b4513" opacity="0.9"/>
            </g>
            
            <!-- 底座裝飾文字 -->
            <text x="160" y="480" 
                  font-family="'Noto Serif TC', serif"
                  font-size="14"
                  fill="#8b4513"
                  text-anchor="middle"
                  opacity="0.7"
                  font-weight="500">
                誠心求籤 • 有求必應
            </text>
            
            <!-- 光暈效果 -->
            <circle cx="160" cy="250" r="80" fill="none" stroke="rgba(255, 215, 0, 0.05)" stroke-width="40"/>
        </svg>
    `;
    
    drawArea.innerHTML = svgContent;
    
    // 重置UI狀態
    document.getElementById('result-display').style.display = 'none';
    document.getElementById('draw-button').style.display = 'block';
    document.getElementById('reset-button').style.display = 'none';
    document.getElementById('draw-button').disabled = false;
    document.getElementById('draw-button').textContent = "🙏 搖晃籤筒，抽取神籤";
    
    // 重置輸入框
    const queryInput = document.getElementById('user-query');
    queryInput.value = '';
    queryInput.focus();
    
    console.log('[知遇籤] 籤筒初始化完成');
}

/**
 * 開始抽籤
 */
async function startDrawing() {
    if (isDrawing) {
        console.log('[知遇籤] 抽籤進行中，請稍候');
        return;
    }
    
    const userQuery = document.getElementById('user-query').value.trim();
    
    // 驗證輸入
    if (userQuery.length < 5) {
        showMessage("請誠心輸入您的問題，至少五個字，以示虔誠！", "warning");
        document.getElementById('user-query').focus();
        return;
    }
    
    if (userQuery.length > 100) {
        showMessage("問題過長，請簡要說明您的疑問（100字以內）", "warning");
        return;
    }
    
    // 設置狀態
    isDrawing = true;
    const drawButton = document.getElementById('draw-button');
    const censerGroup = document.getElementById('censer-svg-group');
    
    drawButton.disabled = true;
    drawButton.textContent = "🙏 正在感應神機...";
    
    try {
        // 1. 確定性抽籤邏輯
        const { queryKey, seed } = generateQuerySeed(userQuery);
        let resultIndex = -1;
        const storedResult = localStorage.getItem(queryKey);
        
        if (storedResult !== null && storedResult !== undefined) {
            resultIndex = parseInt(storedResult);
            if (resultIndex >= 0 && resultIndex < fortuneSticks.length) {
                drawnStickData = fortuneSticks[resultIndex];
                console.log(`[知遇籤] 從本地儲存獲取結果: 第 ${resultIndex + 1} 籤`);
            }
        }
        
        if (!drawnStickData) {
            const scoredSticks = calculateStickScores(userQuery);
            const nextRandom = seededRandom(seed);
            
            if (scoredSticks && scoredSticks.length > 0) {
                drawnStickData = deterministicSelect(scoredSticks, nextRandom);
                resultIndex = fortuneSticks.findIndex(stick => stick.number === drawnStickData.number);
                
                if (resultIndex !== -1) {
                    localStorage.setItem(queryKey, resultIndex.toString());
                    console.log(`[知遇籤] 新抽籤結果已儲存: 第 ${resultIndex + 1} 籤`);
                }
            }
        }
        
        // 確保有結果
        if (!drawnStickData && fortuneSticks.length > 0) {
            drawnStickData = fortuneSticks[Math.floor(Math.random() * fortuneSticks.length)];
        }
        
        // 2. 開始搖籤動畫
        censerGroup.classList.add('shaking');
        safePlayAudio('shaking-sound');
        
        // 隨機選擇一支籤隱藏
        const sticksInCenser = document.querySelectorAll('.stick-in-censer');
        if (sticksInCenser.length > 0) {
            const stickToHide = sticksInCenser[Math.floor(Math.random() * sticksInCenser.length)];
            stickToHide.style.opacity = '0';
            stickToHide.style.transform += ' translateY(-50px)';
        }
        
        // 3. 延遲後開始掉落動畫
        await new Promise(resolve => setTimeout(resolve, 1800));
        
        // 停止搖籤
        censerGroup.classList.remove('shaking');
        const shakingSound = document.getElementById('shaking-sound');
        if (shakingSound) {
            shakingSound.pause();
            shakingSound.currentTime = 0;
        }
        
        // 4. 創建掉落籤
        const svgContainer = document.getElementById('main-svg');
        const fallingStick = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        
        // 設置籤子屬性
        fallingStick.setAttribute('class', 'drawn-stick-svg falling');
        fallingStick.setAttribute('x', '156');
        fallingStick.setAttribute('y', '100');
        fallingStick.setAttribute('width', '8');
        fallingStick.setAttribute('height', '250');
        fallingStick.setAttribute('rx', '3');
        
        // 設置動畫參數
        const dropX = (Math.random() * 100) - 50;
        const dropY = 420;
        const dropRot = (Math.random() * 80) - 40;
        
        fallingStick.style.cssText = `
            --drop-x: ${dropX}px;
            --drop-y: ${dropY}px;
            --drop-rot: ${dropRot}deg;
            animation-duration: 2s;
            opacity: 0;
            fill: #fdf5e6;
            stroke: #d2b48c;
            stroke-width: 1.5;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.3));
        `;
        
        svgContainer.appendChild(fallingStick);
        
        // 觸發動畫
        setTimeout(() => {
            fallingStick.style.opacity = '1';
        }, 10);
        
        // 播放掉落音效
        setTimeout(() => {
            safePlayAudio('drop-sound');
        }, 1500);
        
        // 5. 顯示結果
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        svgContainer.removeChild(fallingStick);
        
        // 顯示結果
        displayResult(drawnStickData, userQuery);
        
        // 播放成功音效
        safePlayAudio('success-sound');
        
        // 更新UI
        drawButton.disabled = false;
        drawButton.textContent = "🙏 搖晃籤筒，抽取神籤";
        drawButton.style.display = 'none';
        document.getElementById('reset-button').style.display = 'block';
        
        isDrawing = false;
        
        // 記錄分析
        logFortuneDraw(userQuery, drawnStickData.number);
        
    } catch (error) {
        console.error('[知遇籤] 抽籤過程中出錯:', error);
        showMessage("抽籤過程中發生錯誤，請刷新頁面重試。", "error");
        resetDrawingState();
    }
}

/**
 * 顯示結果
 */
function displayResult(stickData, query) {
    if (!stickData) {
        console.error('[知遇籤] 無有效的籤文數據');
        return;
    }
    
    const resultDisplay = document.getElementById('result-display');
    const stickMagnified = document.getElementById('drawn-stick-magnified');
    const interpretationText = document.getElementById('interpretation-text');
    const resultTime = document.getElementById('result-time');
    
    // 設置時間戳
    const now = new Date();
    resultTime.textContent = `抽取時間: ${now.toLocaleString('zh-TW')}`;
    
    // 格式化籤文
    const verseLines = stickData.verse
        .split('，')
        .join('，\n')
        .split('。')
        .join('。\n\n');
    
    // 創建籤文顯示
    stickMagnified.innerHTML = `
        <div class="magnified-stick-container">
            <h3>${stickData.number} • ${stickData.title}</h3>
            <div class="stick-content">${verseLines}</div>
            <div class="stick-grade">
                <span class="grade-badge">${getGradeBadge(stickData.title)}</span>
            </div>
        </div>
    `;
    
    // 創建解讀
    const aspects = ['事業', '財運', '婚姻', '健康', '學業', '尋人', '失物'];
    let interpretationParts = stickData.interpretation.split('。');
    let interpretedHtml = '';
    
    // 總體解讀
    let generalInterpretation = interpretationParts.shift();
    if (generalInterpretation) {
        interpretedHtml += `
            <div class="interpretation-section">
                <h4>📋 總體解讀</h4>
                <p>${generalInterpretation}。</p>
            </div>
        `;
    }
    
    // 各領域解讀
    aspects.forEach(aspect => {
        let part = interpretationParts.find(p => p.includes(`**${aspect}：**`));
        if (part) {
            const formattedPart = part.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            interpretedHtml += `
                <div class="interpretation-section">
                    <h4>${getAspectIcon(aspect)} ${aspect}</h4>
                    <p>${formattedPart}。</p>
                </div>
            `;
        }
    });
    
    // 添加用戶問題
    const userQueryHtml = query ? `
        <div class="user-query-container">
            <h4>❓ 您的問題</h4>
            <p class="user-query">${query}</p>
        </div>
    ` : '';
    
    // 添加提醒
    interpretedHtml += `
        <div class="reminder">
            <h4>💡 溫馨提醒</h4>
            <p>籤文是一種指引與參考，最終決策仍需依據您的理性判斷和實際情況。保持積極心態，勇敢面對生活中的挑戰。</p>
        </div>
    `;
    
    interpretationText.innerHTML = userQueryHtml + interpretedHtml;
    
    // 顯示結果區域
    resultDisplay.style.display = 'block';
    
    // 平滑滾動到結果
    setTimeout(() => {
        resultDisplay.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 100);
}

/**
 * 獲取吉凶等級標籤
 */
function getGradeBadge(title) {
    if (title.includes('上吉')) return '🔴 上上大吉';
    if (title.includes('中吉')) return '🟢 中吉';
    if (title.includes('中平')) return '🟡 中平';
    if (title.includes('中下籤')) return '🟠 中下籤';
    if (title.includes('下籤')) return '🔵 下籤';
    return '⚪ 平籤';
}

/**
 * 獲取領域圖標
 */
function getAspectIcon(aspect) {
    const icons = {
        '事業': '💼',
        '財運': '💰',
        '婚姻': '💑',
        '健康': '🏥',
        '學業': '📚',
        '尋人': '🔍',
        '失物': '🔎'
    };
    return icons[aspect] || '📌';
}

/**
 * 顯示消息
 */
function showMessage(message, type = 'info') {
    // 移除現有消息
    const existingMsg = document.querySelector('.message-box');
    if (existingMsg) existingMsg.remove();
    
    // 創建新消息
    const messageBox = document.createElement('div');
    messageBox.className = `message-box message-${type}`;
    messageBox.innerHTML = `
        <span class="message-text">${message}</span>
        <button class="message-close" onclick="this.parentElement.remove()">×</button>
    `;
    
    // 添加到容器
    const container = document.querySelector('.container');
    container.insertBefore(messageBox, container.firstChild);
    
    // 自動消失
    setTimeout(() => {
        if (messageBox.parentElement) {
            messageBox.remove();
        }
    }, 5000);
}

/**
 * 重置抽籤狀態
 */
function resetDrawingState() {
    isDrawing = false;
    
    const drawButton = document.getElementById('draw-button');
    const censerGroup = document.getElementById('censer-svg-group');
    
    if (censerGroup) {
        censerGroup.classList.remove('shaking');
    }
    
    if (drawButton) {
        drawButton.disabled = false;
        drawButton.textContent = "🙏 搖晃籤筒，抽取神籤";
        drawButton.style.display = 'block';
    }
    
    document.getElementById('reset-button').style.display = 'none';
    
    // 停止所有音效
    ['shaking-sound', 'drop-sound', 'success-sound'].forEach(id => {
        const audio = document.getElementById(id);
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
    });
}

/**
 * 重置抽籤
 */
function resetDrawing() {
    initializeDrawing();
    drawnStickData = null;
    
    const resultDisplay = document.getElementById('result-display');
    resultDisplay.style.display = 'none';
    
    window.scrollTo({ 
        top: 0, 
        behavior: 'smooth' 
    });
    
    // 聚焦到輸入框
    const queryInput = document.getElementById('user-query');
    setTimeout(() => {
        queryInput.focus();
    }, 300);
}

/**
 * 分享籤文
 */
function shareFortune() {
    if (!drawnStickData) {
        showMessage("請先抽取籤文", "warning");
        return;
    }
    
    const shareText = `我在「知遇籤」抽到的籤文：
${drawnStickData.number} ${drawnStickData.title}
${drawnStickData.verse}

解讀：${drawnStickData.interpretation.substring(0, 100)}...

👉 前往 jasyooc.com 抽籤`;
    
    if (navigator.share) {
        navigator.share({
            title: '知遇籤 - 我的籤文結果',
            text: shareText,
            url: window.location.href
        }).catch(err => {
            console.log('[知遇籤] 分享取消或失敗:', err);
        });

    } else {
        // 複製到剪貼板
        navigator.clipboard.writeText(shareText).then(() => {
            showMessage("籤文已複製到剪貼板，可以分享給朋友了！", "success");
        }).catch(err => {
            console.error('[知遇籤] 複製失敗:', err);
            showMessage("複製失敗，請手動複製", "error");
        });
    }
}

/**
 * 儲存結果
 */
function saveResult() {
    if (!drawnStickData) {
        showMessage("請先抽取籤文", "warning");
        return;
    }
    
    const results = JSON.parse(localStorage.getItem('fortune-history') || '[]');
    
    const resultEntry = {
        id: Date.now(),
        date: new Date().toISOString(),
        query: document.getElementById('user-query').value.trim(),
        stick: drawnStickData.number,
        title: drawnStickData.title
    };
    
    results.unshift(resultEntry);
    
    // 只保留最近的20條記錄
    if (results.length > 20) {
        results.pop();
    }
    
    localStorage.setItem('fortune-history', JSON.stringify(results));
    showMessage("結果已儲存到歷史記錄", "success");
}

/**
 * 記錄抽籤日誌
 */
function logFortuneDraw(query, stickNumber) {
    const logEntry = {
        timestamp: new Date().toISOString(),
        query: query.substring(0, 50),
        stick: stickNumber,
        referrer: document.referrer || 'direct'
    };
    
    const logs = JSON.parse(localStorage.getItem('fortune-logs') || '[]');
    logs.push(logEntry);
    
    if (logs.length > 100) {
        logs.shift();
    }
    
    localStorage.setItem('fortune-logs', JSON.stringify(logs));
    
    console.log(`[知遇籤] 抽籤記錄: ${query.substring(0, 30)}... → ${stickNumber}`);
}

// --- 事件監聽器 ---
document.addEventListener('DOMContentLoaded', () => {
    console.log('[知遇籤] 應用程式初始化...');
    
    // 初始化籤筒
    initializeDrawing();
    
    // 設置事件監聽器
    document.getElementById('draw-button').addEventListener('click', startDrawing);
    document.getElementById('reset-button').addEventListener('click', resetDrawing);
    
    // 分享按鈕
    const shareButton = document.getElementById('share-button');
    if (shareButton) {
        shareButton.addEventListener('click', shareFortune);
    }
    
    // 儲存按鈕
    const saveButton = document.getElementById('save-button');
    if (saveButton) {
        saveButton.addEventListener('click', saveResult);
    }
    
    // Enter鍵提交
    document.getElementById('user-query').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !isDrawing) {
            e.preventDefault();
            startDrawing();
        }
    });
    
    // 音效加載
    ['shaking-sound', 'drop-sound', 'success-sound'].forEach(id => {
        const audio = document.getElementById(id);
        if (audio) {
            audio.load();
            audio.addEventListener('error', () => {
                console.warn(`[知遇籤] 音效 ${id} 加載失敗`);
            });
        }
    });
    
    // 頁面可見性變化處理
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // 頁面隱藏時停止動畫和音效
            const censerGroup = document.getElementById('censer-svg-group');
            if (censerGroup) {
                censerGroup.classList.remove('shaking');
            }
            
            ['shaking-sound', 'drop-sound', 'success-sound'].forEach(id => {
                const audio = document.getElementById(id);
                if (audio) {
                    audio.pause();
                }
            });
        }
    });
    
    console.log('[知遇籤] 應用程式初始化完成');
});

// --- 全局錯誤處理 ---
window.addEventListener('error', function(event) {
    console.error('[知遇籤] 全局錯誤:', event.error);
    showMessage("應用程式發生錯誤，請刷新頁面重試", "error");
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('[知遇籤] 未處理的 Promise 拒絕:', event.reason);
    showMessage("操作發生意外錯誤，請重試", "error");
});

// 導出全局函數
window.resetDrawing = resetDrawing;
window.shareFortune = shareFortune;